# DeepSeek API 稳定性优化说明

## 问题分析

之前 DeepSeek 接口不稳定，导致问答环节经常不能正常显示或响应很慢，主要原因包括：

1. **没有重试机制**：API 调用失败后直接返回错误
2. **超时设置不合理**：前端30秒，后端60秒，可能不够
3. **没有使用配置的 timeout**：虽然配置了 timeout，但代码中没有使用
4. **没有连接池**：每次请求都创建新连接，可能导致连接不稳定
5. **错误处理不完善**：只捕获了 IOException，其他异常没有处理
6. **多次 API 调用**：问题分类、实体识别、生成答案都需要调用 API，增加了失败概率
7. **前端没有重试机制**：网络错误时直接失败

## 优化方案

### 1. 后端优化（DeepSeekService.java）

#### 1.1 添加重试机制
- ✅ 实现 `generateAnswerWithRetry` 方法，最多重试3次
- ✅ 递增延迟策略：1秒、2秒、3秒
- ✅ 针对不同错误类型采用不同策略：
  - 服务器错误（5xx）：自动重试
  - 速率限制错误：延迟更久后重试
  - 连接错误：递增延迟后重试

#### 1.2 优化超时配置
- ✅ 使用配置文件中的 `timeout`（默认120秒）
- ✅ 连接超时：30秒
- ✅ 读取超时：使用配置值（默认120秒）
- ✅ 写入超时：30秒

#### 1.3 连接池配置
- ✅ 配置连接池（最多10个连接，空闲5分钟）
- ✅ 启用 `retryOnConnectionFailure`，自动重试连接失败

#### 1.4 改进错误处理
- ✅ 区分不同类型的错误（超时、连接失败、服务器错误等）
- ✅ 返回更友好的错误提示
- ✅ 记录详细的错误日志

#### 1.5 减少 API 调用
- ✅ **问题分类**：优先使用关键词匹配，减少 API 调用
- ✅ **实体识别**：优先使用正则表达式提取，减少 API 调用
- ✅ 只有在简单方法失败时才调用 API

### 2. 前端优化

#### 2.1 增加超时时间
- ✅ 将 axios 超时时间从 30 秒增加到 120 秒

#### 2.2 添加重试机制
- ✅ 在 `Chat.vue` 中实现重试逻辑，最多重试2次
- ✅ 递增延迟：1秒、2秒

#### 2.3 改进错误提示
- ✅ 区分不同类型的错误（超时、网络错误、服务器错误等）
- ✅ 提供更友好的错误提示信息

## 配置说明

### application.yml

```yaml
deepseek:
  api:
    url: https://api.deepseek.com/v1/chat/completions
    api-key: ${DEEPSEEK_API_KEY:your-api-key}
    model: deepseek-chat
    timeout: 120000  # 120秒，可以根据需要调整
```

### 超时时间建议

- **快速响应场景**：60-90秒
- **正常使用**：120秒（推荐）
- **复杂问题**：180秒

## 使用效果

### 优化前
- ❌ API 调用失败后直接返回错误
- ❌ 超时时间过短，经常超时
- ❌ 没有重试，网络波动导致失败
- ❌ 多次 API 调用增加失败概率

### 优化后
- ✅ 自动重试，提高成功率
- ✅ 超时时间合理，减少超时错误
- ✅ 连接池提升性能
- ✅ 减少 API 调用次数
- ✅ 更友好的错误提示

## 监控建议

建议添加以下监控指标：

1. **API 调用成功率**：监控成功/失败比例
2. **平均响应时间**：监控 API 响应时间
3. **重试次数统计**：监控需要重试的比例
4. **错误类型分布**：了解主要错误类型

## 进一步优化建议

1. **流式响应**：如果 DeepSeek API 支持流式响应，可以实现逐步显示答案
2. **缓存机制**：对常见问题进行缓存，减少 API 调用
3. **降级策略**：API 完全不可用时，使用本地知识库回答
4. **限流保护**：防止 API 调用过于频繁导致被限流
5. **健康检查**：定期检查 API 可用性

## 测试建议

1. **网络不稳定测试**：模拟网络波动，验证重试机制
2. **超时测试**：测试不同超时时间的表现
3. **并发测试**：测试多用户同时使用时的稳定性
4. **错误恢复测试**：测试各种错误场景下的恢复能力



















